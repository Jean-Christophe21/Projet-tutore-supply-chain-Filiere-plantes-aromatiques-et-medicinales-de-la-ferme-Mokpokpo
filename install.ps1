# Installation Complète - Projet Mokpokpo
# Ce script installe et vérifie tout automatiquement

Write-Host ""
Write-Host "??????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?   Installation Projet Mokpokpo ??      ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# ???????????????????????????????????????????????????????????????
# ÉTAPE 1 : Vérification des Prérequis
# ???????????????????????????????????????????????????????????????

Write-Host "?? Étape 1/3 : Vérification des prérequis..." -ForegroundColor Yellow
Write-Host ""

$hasError = $false

# Vérifier Python
if (Get-Command python -ErrorAction SilentlyContinue) {
    $pythonVersion = python --version
    Write-Host "? Python : $pythonVersion" -ForegroundColor Green
} else {
    Write-Host "? Python n'est pas installé" -ForegroundColor Red
    Write-Host "   Téléchargez : https://www.python.org/downloads/" -ForegroundColor Yellow
    $hasError = $true
}

# Vérifier Node.js
if (Get-Command node -ErrorAction SilentlyContinue) {
    $nodeVersion = node --version
    Write-Host "? Node.js : $nodeVersion" -ForegroundColor Green
} else {
    Write-Host "? Node.js n'est pas installé" -ForegroundColor Red
    Write-Host "   Téléchargez : https://nodejs.org/" -ForegroundColor Yellow
    $hasError = $true
}

# Vérifier PostgreSQL
if (Get-Command psql -ErrorAction SilentlyContinue) {
    Write-Host "? PostgreSQL installé" -ForegroundColor Green
} else {
    Write-Host "??  PostgreSQL (psql) non détecté - Vérifiez pgAdmin" -ForegroundColor Yellow
}

if ($hasError) {
    Write-Host ""
    Write-Host "? Installation impossible - Installez les prérequis manquants" -ForegroundColor Red
    Write-Host ""
    pause
    exit 1
}

Write-Host ""

# ???????????????????????????????????????????????????????????????
# ÉTAPE 2 : Installation Backend (Python)
# ???????????????????????????????????????????????????????????????

Write-Host "?? Étape 2/3 : Installation des modules Python..." -ForegroundColor Yellow
Write-Host ""

# Mettre à jour pip
Write-Host "Mise à jour de pip..." -ForegroundColor Gray
python -m pip install --upgrade pip --quiet 2>&1 | Out-Null

# Aller dans Backend
$backendPath = Join-Path $PSScriptRoot "Backend"
if (-not (Test-Path $backendPath)) {
    Write-Host "? Dossier Backend introuvable" -ForegroundColor Red
    pause
    exit 1
}

cd $backendPath

# Installer les modules
Write-Host "Installation des modules (cela peut prendre 2-3 minutes)..." -ForegroundColor Gray

$installOutput = python -m pip install -r requirements.txt --user 2>&1

if ($LASTEXITCODE -eq 0) {
    Write-Host "? Modules Python installés" -ForegroundColor Green
} else {
    # Essayer sans --user
    Write-Host "Nouvelle tentative sans --user..." -ForegroundColor Gray
    $installOutput = python -m pip install -r requirements.txt 2>&1
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "? Modules Python installés" -ForegroundColor Green
    } else {
        Write-Host "? Erreur d'installation Python" -ForegroundColor Red
        Write-Host "Essayez manuellement : cd Backend && pip install -r requirements.txt" -ForegroundColor Yellow
    }
}

# Vérifier sqlalchemy
$sqlCheck = python -c "import sqlalchemy; print('OK')" 2>&1
if ($sqlCheck -like "*OK*") {
    Write-Host "? sqlalchemy accessible" -ForegroundColor Green
} else {
    Write-Host "??  sqlalchemy non accessible - Réinstallez manuellement" -ForegroundColor Yellow
}

cd ..
Write-Host ""

# ???????????????????????????????????????????????????????????????
# ÉTAPE 3 : Installation Frontend (Node.js)
# ???????????????????????????????????????????????????????????????

Write-Host "??  Étape 3/3 : Installation des modules Node.js..." -ForegroundColor Yellow
Write-Host ""

$frontendPath = Join-Path $PSScriptRoot "Frontend"
if (-not (Test-Path $frontendPath)) {
    Write-Host "? Dossier Frontend introuvable" -ForegroundColor Red
    pause
    exit 1
}

cd $frontendPath

Write-Host "Installation des modules (cela peut prendre 3-5 minutes)..." -ForegroundColor Gray

if (Get-Command npm -ErrorAction SilentlyContinue) {
    npm install --silent 2>&1 | Out-Null
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "? Modules Node.js installés" -ForegroundColor Green
    } else {
        Write-Host "? Erreur d'installation Node.js" -ForegroundColor Red
        Write-Host "Essayez manuellement : cd Frontend && npm install" -ForegroundColor Yellow
    }
} else {
    Write-Host "? npm non disponible" -ForegroundColor Red
}

cd ..
Write-Host ""

# ???????????????????????????????????????????????????????????????
# Résumé et Prochaines Étapes
# ???????????????????????????????????????????????????????????????

Write-Host ""
Write-Host "??????????????????????????????????????????" -ForegroundColor Green
Write-Host "?     ? Installation Terminée !         ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????" -ForegroundColor Green
Write-Host ""

# Vérifier si .env existe
$envPath = Join-Path $backendPath ".env"
if (-not (Test-Path $envPath)) {
    Write-Host "??  IMPORTANT : Configurez la base de données" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "1. Créez la base de données 'mokpokpo' dans pgAdmin" -ForegroundColor White
    Write-Host "2. Copiez Backend\.env.example vers Backend\.env" -ForegroundColor White
    Write-Host "3. Modifiez le mot de passe dans .env" -ForegroundColor White
    Write-Host ""
    Write-Host "Ensuite lancez : .\start.ps1" -ForegroundColor Cyan
} else {
    Write-Host "? Fichier .env détecté" -ForegroundColor Green
    Write-Host ""
    Write-Host "Vous pouvez maintenant lancer : .\start.ps1" -ForegroundColor Cyan
}

Write-Host ""
Write-Host "?? Consultez GUIDE-COMPLET.md pour plus d'aide" -ForegroundColor Gray
Write-Host ""
pause
